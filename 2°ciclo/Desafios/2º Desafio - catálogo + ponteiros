#include <stdio.h>
#include<stdlib.h>
#include <locale.h>

struct dados{
    char nome[21];
    int quantidade;
    float preco;
    int mes;
    int ano;
};

int Menu() {
    int Resposta;
    printf("**--------------- Bem vindo ao menu do nosso catálogo de filmes ---------------**\n\n");
    printf("1 - Entrada de dados do filme\n");
    printf("2 - Lista todos os dados na tela\n");
    printf("3 - Pesquisa um filme pelo nome completo e mostra todos os dados na tela\n");
    printf("4 - Pesquisar data de lançamento do filme (mês/ano)\n");
    printf("5 - Listar filmes por faixa de preço.\n");
    printf("6 - Altera quantidade em estoque (entrada e saída).\n");
    printf("7 - Altera preço de um filme pesquisado pelo nome completo\n");
    printf("8 - Altera todos os dados do filme pesquisado pelo nome completo\n");
    printf("9 - Exclui filme pesquisado pelo nome completo\n");
    printf("10 - Saída\n");
    printf("\nDigite a opção que deseja: ");
    scanf("%d",&Resposta);
    getchar();
    system("cls");
    return Resposta;
}

void Entrada(FILE *catalogo, struct dados filme, char *filmepesquisado){
    int x;
    long pesquisa;
    catalogo = fopen("catalogo.txt", "a"); // "a"para apenas adicionar

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    printf("Digite o nome do filme: ");
    do{
        scanf("%s",filmepesquisado); // sem o "&", pois "pesquisa" já é um endereço
        getchar();
        pesquisa = Pesquisa(catalogo, filme, pesquisa);
        if(pesquisa > -1){
            printf("Esse filme já está cadastrado! Favor inserir outro: ");
        }
    }while(pesquisa > -1);

    for(x = 0; filmepesquisado[x] != '\0'; x++)
        filme.nome[x] = filmepesquisado[x];

    printf("Digite a quantidade disponivel: ");
    do{
        scanf("%d",&filme.quantidade);
        getchar();
        if(filme.quantidade < 0)
            printf("A quantidade disponível deve ser maior ou igual a 0: ");
    }while(filme.quantidade < 0);

    printf("Digite o preço do filme: ");
    do{
        scanf("%f",&filme.preco);
        getchar();
        if(filmes.preco <= 0)
            printf("O preço do filme deve ser maior que 0: ");
    }while(filmes.preco <= 0);

    printf("Digite o mês de laçamento: ");
    do{
        scanf("%d",&filme.mes);
        getchar();
        if(filme.mes > 12 || filme.mes < 1)
            printf("O mês deve ser uma número entre 1 e 12: ");
    }while(filme.mes > 12 || filme.mes < 1);

    printf("Digite o ano de laçamento: ");
    do{
        scanf("%d",&filme.ano);
        if(filme.ano < 1895)
            printf("O ano deve ser igual ou superior a 1895: "); // data do primiero filme lançado
    }while(filme.ano < 1895);
        fwrite(&filme, sizeof(filme),1,catalogo);
        printf("\nFilme cadastrado com sucesso!!!\n");
        fclose(catalogo);
}

void Listagem(FILE *catalogo, struct dados filme) {
    catalogo = fopen("catalogo.txt", "r");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }
    else{
        while(fread(&filme, sizeof(filme),1,catalogo) == 1){
            if(filme.nome[0] != '*') {
                printf("Nome do filme: %s\n",filme.nome);
                printf("Quantidade disponível: %d",filme.quantidade);
                printf("\nPreço: %.2f\n",filme.preco);
                printf("Data de lançamento: %d/%d\n\n",filme.mes, filme.ano);
            }
        }
    fclose(catalogo);
    }
}

long Pesquisa(FILE *catalogo, struct dados filme, char *filmepesquisado) {
    int x, posicao = 0;
    catalogo = fopen("catalogo.txt","r");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    else{
        while(fread(&filme,sizeof(filme),1,catalogo) == 1){
            for(x = 0; filmepesquisado[x] != '\0'; x++)
                if(filme.nome[x]!= filmepesquisado[x])
                    break;
            if(filme.nome[x]== '\0' && filmepesquisado[x] == '\0') {
                printf("Nome do filme: %s\n",filme.nome);
                printf("Quantidade disponível: %d",filme.quantidade);
                printf("\nPreço: %.2f\n",filme.preco);
                printf("Data de lançamento: %d/%d\n\n",filme.mes, filme.ano);
                fclose(catalogo);
                return posicao; // se tiver alguma igual
            }
            posicao++;
        }
    }
    fclose(catalogo);
    return -1;
}

void PesquisaData(FILE *catalogo, struct dados filme) {
    int ano, mes, cont = 0;

    catalogo = fopen("catalogo.txt","r");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    else{
        printf("Insira o ano de lançamento do filme: ");
        scanf("%d",&ano);
        getchar();

        printf("Insira o mês de lançamento do filme: ");
        scanf("%d",&mes);
        getchar();

        while(fread(&filme,sizeof(filme),1,catalogo)== 1){
            if(ano == filme.ano && mes == filme.mes && filme.nome[0] != '*') {
                printf("\nNome do filme: %s\n",filme.nome);
                printf("Quantidade disponível: %d",filme.quantidade);
                printf("\nPreço: %.2f\n",filme.preco);
                printf("Data de lançamento: %d/%d\n\n",filme.mes, filme.ano);
            }
        }
        if(cont == 0)
            printf("Não há filmes cadastrados com essa data de lançamento");
    }
    fclose(catalogo);
}

void FaixaPreco(FILE *catalogo, struct dados filme) {
   float min, max, cont = 0;

    catalogo = fopen("catalogo.txt","r");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    else{
        printf("Insira o preço mínimo: ");
        scanf("%f",&min);
        getchar();

        printf("Insira o preço máximo: ");
        scanf("%f",&max);
        getchar();

        while(fread(&filme,sizeof(filme),1,catalogo)== 1){
            if(filme.preco > min && filme.preco < max && filme.nome[0] != '*') {
                printf("\nNome do filme: %s\n",filme.nome);
                printf("Quantidade disponível: %d",filme.quantidade);
                printf("\nPreço: %.2f\n",filme.preco);
                printf("Data de lançamento: %d/%d\n\n",filme.mes, filme.ano);
                cont++;
            }
        }
        if(cont == 0)
            printf("Não há filmes cadastrados nessa faixa de preço");
    }
    fclose(catalogo);
}

void AlteraEstoque(FILE *catalogo, struct dados filme, char *filmepesquisado){
    int Consulta, Novaquant;
    printf("\n");
    Consulta = Pesquisa(catalogo, filme, filmepesquisado);

        if(Consulta == -1){
            printf("Filme não cadastrado!!!");
            return
        }

        else {
            catalogo = fopen("catalogo.txt","r+");
            if(catalogo == NULL){
                printf("Não foi possível abrir o catálogo");
                fclose(catalogo);
                return;
            }
            else {
                fseek(catalogo, Consulta * sizeof(filme), SEEK_SET); //coloca na posição
                fread(&filme, sizeof(filme),1,catalogo); // lê oq tá lá
                printf("Insira a nova quantidade: ");
                scanf("%d",&Novaquant);
                getchar();
                filme.quantidade = Novaquant;
                fseek(catalogo, Consulta * sizeof(filme), SEEK_SET);
                fwrite(&filme, sizeof(filme),1,catalogo);
            }
        }
    fclose(catalogo);
    printf("\nQuantidade atualizada com sucesso!!!\n\n");
}

void ALteraPreco(FILE *catalogo, struct dados filme, char *filmepesquisado) {
    int Consulta;
    float Novopreco;

    printf("\n");
    Consulta = Pesquisa(catalogo, filme, filmepesquisado);
    catalogo = fopen("catalogo.txt", "r+");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    else{
        if(Consulta == -1){
            printf("Filme não cadastrado!!!");
            fclose(catalogo);
        }

        else {
            fseek(catalogo, Consulta * sizeof(filme), SEEK_SET);
            fread(&filme, sizeof(filme),1,catalogo);
            printf("Insira o novo preco: ");
            scanf("%f",&Novopreco);
            getchar();
            filme.preco = Novopreco;
            fseek(catalogo, Consulta * sizeof(filme), SEEK_SET);
            fwrite(&filme, sizeof(filme),1,catalogo);
        }
    }
    fclose(catalogo);
    printf("\nPreço atualizado com sucesso!!!\n\n");
}

void AlteraTudo(FILE *catalogo, struct dados filme, char *filmepesquisado){
    int Consulta, Novaquant;
    float Novopreco;

    printf("\n");
    Consulta = Pesquisa(catalogo, filme, filmepesquisado);
    catalogo = fopen("catalogo.txt", "r+");

    if(catalogo == NULL){
        printf("Não foi possível abrir o catálogo");
        fclose(catalogo);
        return;
    }

    else{
        if(Consulta == -1){
            printf("Filme não cadastrado!!!");
            fclose(catalogo);
        }

        else {
            fseek(catalogo, Consulta * sizeof(filme), SEEK_SET);
            fread(&filme, sizeof(filme),1,catalogo);
            printf("Insira a nova quantidade: ");
            scanf("%d",&Novaquant);
            getchar();
            filme.quantidade = Novaquant;

            printf("Insira o novo preco: ");
            scanf("%f",&Novopreco);
            getchar();
            filme.preco = Novopreco;
            fseek(catalogo, Consulta * sizeof(filme), SEEK_SET);
            fwrite(&filme, sizeof(filme),1,catalogo);
        }
    }
    fclose(catalogo);
    printf("\nPreço atualizado com sucesso!!!\n\n");
}

void ExluiFilme(FILE *catalogo, struct dados filme){

}
void Saida() {
    printf("Fechando o menu...\n\n");
    exit(0);
}
int main(){
    int Resposta;
    struct dados filme;
    char filmepesquisado[21];
    FILE *catalogo;
    setlocale(LC_ALL,"");

    for(;;) {
        system("cls");
        switch(Menu()) {
            case 1:
                Entrada(catalogo, filme, filmepesquisado);
            break;

            case 2:
                Listagem(catalogo, filme);
            break;

            case 3:
                printf("Insira o nome do filme que deseja consultar: ");
                gets(filmepesquisado);
                if(Pesquisa(catalogo, filme,filmepesquisado) == -1)
                    printf("Esse filme não está cadastrado!!!\n\n");
            break;

            case 4:
                PesquisaData(catalogo, filme);
            break;

            case 5:
                FaixaPreco(catalogo, filme);
            break;

            case 6:
                printf("Insira o nome do filme que deseja alterar a quantidade: ");
                gets(filmepesquisado);
                AlteraEstoque(catalogo, filme, filmepesquisado);
            break;

            case 7:

            break;

            case 8:

            break;

            case 9:

            break;
            case 10:
                Saida();
            break;
        }
        system("pause");
    }
    return 0;
}
